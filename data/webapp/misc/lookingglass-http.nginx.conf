server {
    # Comment out/delete IPv6 line to only listen/serve IPv4
    listen 80 default_server;
    listen [::]:80 default_server ipv6only=on;

    #
    server_name _;
		
    #
    root /var/www/html/LookingGlass;

    # Individual logs for LookingGlass
    access_log /var/log/nginx/lookingglass.access.log;
    error_log  /var/log/nginx/lookingglass.error.log;

    # Set index and use UTF-8
    index index.php;
    charset utf-8;

    # The X-Frame-Options HTTP response header can be used to indicate whether
    # or not a browser should be allowed to render a page in a <frame>, <iframe> or <object> .
    add_header X-Frame-Options SAMEORIGIN;

    # Content Security Policy (CSP) prevent cross-site scripting (XSS), clickjacking and other code injection attacks resulting from execution of malicious content in the trusted web page context.
    add_header Content-Security-Policy "default-src 'none'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src data:; connect-src 'self'";

    # The Set-Cookie HTTP response header is used to send a cookie from the server to the user agent, so that the user agent can send it back to the server later.
    add_header Set-Cookie "Path=/; HttpOnly; Secure; SameSite=Strict";

    # The Access-Control-Allow-Origin response header indicates whether the response can be shared with requesting code from the given origin.
    add_header Access-Control-Allow-Origin none;


    # The X-Content-Type-Options header with the value nosniff ensures that user agents do not attempt to guess the format of the data being received.
    add_header X-Content-Type-Options "nosniff";

    # Stop page from loading when they detected reflected cross-site scripting (XSS) attacks
    add_header X-XSS-Protection "1; mode=block";

    # Permissions Policy provides mechanisms for web developers to explicitly declare what functionality can and cannot be used on a website. You define a set of "policies" that restrict what APIs the site's code can access or modify the browser's default behavior for certain features.
    add_header Permissions-Policy "accelerometer=(), autoplay=(), camera=(), cross-origin-isolated=(), display-capture=(), encrypted-media=(), fullscreen=(), geolocation=(), gyroscope=(), keyboard-map=(), magnetometer=(), microphone=(), midi=(), payment=(), picture-in-picture=(), publickey-credentials-get=(), screen-wake-lock=(), sync-xhr=(), usb=(), web-share=(), xr-spatial-tracking=()";


    # The HTTP Strict-Transport-Security response header (often abbreviated as HSTS) informs browsers that the site should only be accessed using HTTPS, and that any future attempts to access it using HTTP should automatically be converted to HTTPS.
    add_header Strict-Transport-Security 'max-age=31536000; includeSubDomains; preload';

    # The Referrer-Policy HTTP header controls how much referrer information (sent with the Referer header) should be included with requests. Aside from the HTTP header.
    add_header Referrer-Policy "same-origin";


    # Do not send Nginx version
    server_tokens off;

    # Validate request type
    if ($request_method !~ ^(GET|HEAD|POST)$ ) {
        return 403;
    }

    # Disable log for robots.txt
    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    # Deny access to private folder/s
    location /LookingGlass {
        deny all;
        return 404;
    }

    # Deny access to hidden files/folders
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
        return 404;
    }

    # is one of a number of common tricks to overcome a particular script injection exploit
    location / {
        try_files $uri $uri/ =404;
    }

    # CSS/IMG/JS caching policy.
    location ~* \.(?:css|js|gif|jpe?g|png)$ {
        access_log off;
        expires 30d;
        add_header Cache-Control public;
        break;
    }

    # Disable Gzip for test files
    location ~* \.bin$ {
        gzip off;
        sendfile on;
    }

    # Full PHP setup. No includes necessary
    location ~ \.php$ {
        fastcgi_pass unix:/run/php/php-fpm.sock;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        include        fastcgi_params;

        # Enable output buffering
        try_files $uri = 404;
        fastcgi_buffering on;
        fastcgi_buffer_size 1k;
        fastcgi_buffers 28 1k;
        fastcgi_max_temp_file_size 0;
        gzip off;
    }
}
